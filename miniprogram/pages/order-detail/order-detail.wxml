<view class="container">
  <view class="header">
    <text class="title">è®¢å•è¯¦æƒ…</text>
  </view>
  
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <block wx:elif="{{orderInfo}}">
    
    <!-- åœ°å€ä¿¡æ¯ -->
    <view class="address-section">
      <view class="section-title">é…é€ä¿¡æ¯</view>
      <view class="address-content">
        <view class="address-line">
          <text class="label">æ”¶è´§äººï¼š</text>
          <text class="value">{{orderInfo.contactName}}</text>
        </view>
        <view class="address-line">
          <text class="label">è”ç³»ç”µè¯ï¼š</text>
          <text class="value">{{orderInfo.contactPhone}}</text>
        </view>
        <view class="address-line">
          <text class="label">æ”¶è´§åœ°å€ï¼š</text>
          <text class="value">{{orderInfo.address}}</text>
        </view>
      </view>
    </view>
    
    <!-- è®¢å•å•†å“ -->
    <view class="order-items">
      <view class="section-title">è®¢å•å•†å“</view>
      
      <view class="item-list">
        <view class="item" wx:for="{{orderInfo.items}}" wx:key="productId">
          <image 
            class="item-image"
            src="{{item.imageURL || '/images/default-product.png'}}" 
            mode="aspectFill"
            lazy-load="{{true}}"
          />
          <view class="item-info">
            <view class="item-name">{{item.productName}}</view>
            <view class="item-price-qty">
              <text class="item-price">Â¥{{item.formattedProductPrice}}</text>
              <text class="item-qty">x{{item.quantity}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ğŸ†• æŠ˜å å¼è®¢å•çŠ¶æ€å†å² -->
    <view class="order-status-section">
      <view class="section-header">
        <text class="section-title">è®¢å•çŠ¶æ€</text>
        <view class="toggle-btn" bindtap="toggleStatusHistory">
          <text class="toggle-text">{{showStatusHistory ? 'æ”¶èµ·' : 'æŸ¥çœ‹è¯¦æƒ…'}}</text>
          <text class="arrow {{showStatusHistory ? 'up' : 'down'}}">{{showStatusHistory ? 'â–²' : 'â–¼'}}</text>
        </view>
      </view>
      
      <!-- å½“å‰çŠ¶æ€æ¦‚è§ˆï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
      <view class="current-status-overview">
        <view class="status-current">
          <view class="status-dot" style="background-color: {{orderInfo.statusColor}}"></view>
          <text class="status-text">{{orderInfo.statusText}}</text>
        </view>
        <view class="status-time">{{orderInfo.updateTime}}</view>
        
        <view class="create-time">
          <text class="label">ä¸‹å•æ—¶é—´ï¼š</text>
          <text class="value">{{orderInfo.createTime}}</text>
        </view>
      </view>
      
      <!-- è¯¦ç»†çŠ¶æ€å†å²ï¼ˆå¯æŠ˜å ï¼‰ -->
      <view class="status-history-detail {{showStatusHistory ? 'expanded' : 'collapsed'}}">
        <view class="loading-history" wx:if="{{loadingHistory && !isLoadingMore}}">
          <text>åŠ è½½çŠ¶æ€å†å²...</text>
        </view>
        
        <scroll-view 
          class="timeline-scroll" 
          scroll-y="{{true}}" 
          bindscrolltolower="loadMoreHistory"
          lower-threshold="100"
          enable-flex="true"
          enhanced="true"
          wx:if="{{statusHistoryList.length > 0}}">
          
          <view class="timeline-container">
            <view class="timeline-item {{item.statusType}}" wx:for="{{statusHistoryList}}" wx:key="_id">
              <view class="timeline-left">
                <view class="timeline-dot {{item.statusType}}"></view>
                <view class="timeline-line" wx:if="{{index < statusHistoryList.length - 1}}"></view>
              </view>
              <view class="timeline-right">
                <view class="timeline-header">
                  <text class="status-name {{item.statusType}}">{{item.statusText}}</text>
                  <text class="operator">{{item.operatorText}}</text>
                </view>
                <view class="timeline-time">{{item.timeText}}</view>
                
                <!-- ğŸ†• ç”¨æˆ·å‹å¥½çš„å¤‡æ³¨æ˜¾ç¤º -->
                <view class="timeline-remark {{item.statusType}}" wx:if="{{item.displayRemark}}">
                  <text class="remark-text">{{item.displayRemark}}</text>
                </view>
                
                <!-- ğŸ†• ç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯æç¤º -->
                <view class="user-message" wx:if="{{item.userFriendlyMessage}}">
                  <text class="message-text">ğŸ’¡ {{item.userFriendlyMessage}}</text>
                </view>
                
                <!-- ğŸ†• å¤±è´¥çŠ¶æ€çš„è”ç³»å®¢æœæŒ‰é’® -->
                <view class="contact-service" wx:if="{{item.showContactService}}">
                  <text class="service-text" bindtap="contactService">å¦‚æœ‰ç–‘é—®ï¼Œç‚¹å‡»è”ç³»å®¢æœ</text>
                </view>
                
                <view class="timeline-transition" wx:if="{{item.fromStatusText && item.fromStatusText !== item.statusText && !item.isFailed}}">
                  <text class="transition-text">ä»"{{item.fromStatusText}}"å˜æ›´ä¸º"{{item.statusText}}"</text>
                </view>
              </view>
            </view>
            
            <!-- åŠ è½½æ›´å¤šæç¤º -->
            <view class="loading-more" wx:if="{{isLoadingMore}}">
              <text>åŠ è½½æ›´å¤š...</text>
            </view>
            
            <!-- æ²¡æœ‰æ›´å¤šæ•°æ®æç¤º -->
            <view class="no-more-data" wx:if="{{!hasMoreHistory && statusHistoryList.length > 0 && historyPage > 1}}">
              <text>æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
            </view>
          </view>
        </scroll-view>
        
        <view class="no-history" wx:elif="{{showStatusHistory && !loadingHistory}}">
          <text class="no-history-text">æš‚æ— çŠ¶æ€å˜æ›´è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="order-info">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      
      <view class="info-item">
        <text class="label">è®¢å•ç¼–å·</text>
        <view class="value-with-copy">
          <text class="value">{{orderInfo._id}}</text>
          <text class="copy-btn" bindtap="copyOrderId">å¤åˆ¶</text>
        </view>
      </view>
      <view class="info-item">
        <text class="label">ä¸‹å•æ—¶é—´</text>
        <text class="value">{{orderInfo.createTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.payTime}}">
        <text class="label">æ”¯ä»˜æ—¶é—´</text>
        <text class="value">{{orderInfo.payTime}}</text>
      </view>
      <!-- ğŸ†• æ–°å¢çŠ¶æ€æ—¶é—´æ˜¾ç¤º -->
      <view class="info-item" wx:if="{{orderInfo.acceptTime}}">
        <text class="label">æ¥å•æ—¶é—´</text>
        <text class="value">{{orderInfo.acceptTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.deliverTime}}">
        <text class="label">é…é€æ—¶é—´</text>
        <text class="value">{{orderInfo.deliverTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.deliveredTime}}">
        <text class="label">é…é€å®Œæˆæ—¶é—´</text>
        <text class="value">{{orderInfo.deliveredTime}}</text>
      </view>
      <!-- ğŸ”§ ä¿®å¤ï¼šåŸºäºè®¢å•çŠ¶æ€æ™ºèƒ½æ˜¾ç¤ºé€€æ¬¾æ—¶é—´ -->
      <view class="info-item" wx:if="{{orderInfo.refundingTime}}">
        <text class="label">é€€æ¬¾æ—¶é—´</text>
        <text class="value">{{orderInfo.refundingTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.completeTime}}">
        <text class="label">å®Œæˆæ—¶é—´</text>
        <text class="value">{{orderInfo.completeTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.status === 'cancelled' && orderInfo.cancelTime}}">
        <text class="label">ä¸­æ­¢æ—¶é—´</text>
        <text class="value">{{orderInfo.cancelTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.status === 'cancelled' && orderInfo.cancelReason}}">
        <text class="label">ä¸­æ­¢åŸå› </text>
        <text class="value cancel-reason">{{orderInfo.cancelReason}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.status === 'cancelled' && orderInfo.cancelOperator}}">
        <text class="label">æ“ä½œäºº</text>
        <text class="value cancel-operator">{{orderInfo.cancelOperator}}</text>
      </view>
      <view class="info-item">
        <text class="label">æ”¯ä»˜çŠ¶æ€</text>
        <text class="value payment-refunded" wx:if="{{orderInfo.status === 'cancelled'}}">å·²é€€æ¬¾</text>
        <text class="value payment-refunding" wx:elif="{{orderInfo.status === 'refunding'}}">é€€æ¬¾ä¸­</text>
        <text class="value" wx:else>{{orderInfo.isPaid ? 'å·²æ”¯ä»˜' : 'æœªæ”¯ä»˜'}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.remark}}">
        <text class="label">è®¢å•å¤‡æ³¨</text>
        <text class="value">{{orderInfo.remark}}</text>
      </view>
    </view>
    
    <!-- è®¢å•é‡‘é¢ -->
    <view class="order-price">
      <view class="section-title">è®¢å•é‡‘é¢</view>
      
      <view class="price-item">
        <text class="label">å•†å“æ€»é¢</text>
        <text class="value">Â¥{{orderInfo.formattedTotalPrice}}</text>
      </view>
      <view class="price-item">
        <text class="label">é…é€è´¹</text>
        <text class="value">Â¥0.00</text>
      </view>
      <view class="price-item total">
        <text class="label">å®ä»˜æ¬¾</text>
        <text class="value">Â¥{{orderInfo.formattedTotalPrice}}</text>
      </view>
    </view>
    
    <!-- ğŸ†• åŠ¨æ€æ“ä½œæŒ‰é’® -->
    <view class="footer" wx:if="{{actionButtons.length > 0}}">
      <view 
        class="btn {{item.type === 'primary' ? 'btn-primary' : item.type === 'warn' ? 'btn-warn' : 'btn-default'}}"
        wx:for="{{actionButtons}}" 
        wx:key="action"
        data-action="{{item.action}}"
        bindtap="handleOrderAction"
      >
        {{item.text}}
      </view>
    </view>
    
    <!-- ğŸ†• é€šç”¨æ“ä½œæŒ‰é’® -->
    <view class="footer-extra">
      <view class="btn btn-default" bindtap="contactService">è”ç³»å®¢æœ</view>
      <view class="btn btn-default" bindtap="buyAgain" wx:if="{{orderInfo.status === 'completed'}}">å†æ¬¡è´­ä¹°</view>
    </view>
  </block>
  
  <view class="empty-data" wx:else>
    <text>è®¢å•ä¸å­˜åœ¨æˆ–å·²åˆ é™¤</text>
  </view>
</view> 