<view class="container">
  <view class="header">
    <text class="title">è®¢å•è¯¦æƒ…</text>
  </view>
  
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-indicator"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <block wx:elif="{{orderInfo}}">
    <!-- å•†å“ä¿¡æ¯ -->
    <view class="product-section">
      <view class="section-title">å•†å“ä¿¡æ¯</view>
      <view class="product-list clickable">
        <view class="product-item" wx:for="{{orderInfo.items}}" wx:key="productId">
          <image 
            class="product-image" 
            src="{{item.imageURL || '/images/default-product.png'}}" 
            mode="aspectFill"
            lazy-load="{{true}}"
          />
          <view class="product-info">
            <text class="product-name">{{item.productName}}</text>
            <text class="product-price">å•ä»·: Â¥{{item.formattedProductPrice}}</text>
            <text class="product-quantity">æ•°é‡: {{item.quantity}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ğŸ†• æŠ˜å å¼è®¢å•çŠ¶æ€å†å² -->
    <view class="order-status-section">
      <view class="section-header">
        <text class="section-title">è®¢å•çŠ¶æ€</text>
        <view class="toggle-btn" bindtap="toggleStatusHistory">
          <text class="toggle-text">{{showStatusHistory ? 'æ”¶èµ·' : 'æŸ¥çœ‹è¯¦æƒ…'}}</text>
          <text class="arrow {{showStatusHistory ? 'up' : 'down'}}">{{showStatusHistory ? 'â–²' : 'â–¼'}}</text>
        </view>
      </view>
      
      <!-- å½“å‰çŠ¶æ€æ¦‚è§ˆï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
      <view class="current-status-overview">
        <view class="status-current">
          <view class="status-dot" style="background-color: {{orderInfo.statusColor}}"></view>
          <text class="status-text">{{orderInfo.statusText}}</text>
        </view>
        <view class="status-time">{{orderInfo.updateTime}}</view>
        
        <view class="create-time">
          <text class="label">ä¸‹å•æ—¶é—´ï¼š</text>
          <text class="value">{{orderInfo.createTime}}</text>
        </view>
      </view>
      
      <!-- è¯¦ç»†çŠ¶æ€å†å²ï¼ˆå¯æŠ˜å ï¼‰ -->
      <view class="status-history-detail {{showStatusHistory ? 'expanded' : 'collapsed'}}">
        <view class="loading-history" wx:if="{{loadingHistory && !isLoadingMore}}">
          <text>åŠ è½½çŠ¶æ€å†å²...</text>
        </view>
        
        <scroll-view 
          class="timeline-scroll" 
          scroll-y="{{true}}" 
          bindscrolltolower="loadMoreHistory"
          lower-threshold="100"
          enable-flex="true"
          enhanced="true"
          wx:if="{{statusHistoryList.length > 0}}">
          
          <view class="timeline-container">
            <view class="timeline-item {{item.statusType}}" wx:for="{{statusHistoryList}}" wx:key="_id">
              <view class="timeline-left">
                <view class="timeline-dot {{item.statusType}}"></view>
                <view class="timeline-line" wx:if="{{index < statusHistoryList.length - 1}}"></view>
              </view>
              <view class="timeline-right">
                <view class="timeline-header">
                  <text class="status-name {{item.statusType}}">{{item.statusText}}</text>
                  <text class="operator">{{item.operatorText}}</text>
                </view>
                <view class="timeline-time">{{item.timeText}}</view>
                
                <!-- ç”¨æˆ·å‹å¥½çš„å¤‡æ³¨æ˜¾ç¤º -->
                <view class="timeline-remark {{item.statusType}}" wx:if="{{item.displayRemark}}">
                  <text class="remark-text">{{item.displayRemark}}</text>
                </view>
                
                <!-- ç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯æç¤º -->
                <view class="user-message" wx:if="{{item.userFriendlyMessage}}">
                  <text class="message-text">ğŸ’¡ {{item.userFriendlyMessage}}</text>
                </view>
                
                <!-- å¤±è´¥çŠ¶æ€çš„è”ç³»å®¢æœæŒ‰é’® -->
                <view class="contact-service" wx:if="{{item.showContactService}}">
                  <text class="service-text" bindtap="contactService">å¦‚æœ‰ç–‘é—®ï¼Œç‚¹å‡»è”ç³»å®¢æœ</text>
                </view>
                
                <view class="timeline-transition" wx:if="{{item.fromStatusText && item.fromStatusText !== item.statusText && !item.isFailed}}">
                  <text class="transition-text">ä»"{{item.fromStatusText}}"å˜æ›´ä¸º"{{item.statusText}}"</text>
                </view>
              </view>
            </view>
            
            <!-- åŠ è½½æ›´å¤šæç¤º -->
            <view class="loading-more" wx:if="{{isLoadingMore}}">
              <text>åŠ è½½æ›´å¤š...</text>
            </view>
            
            <!-- æ²¡æœ‰æ›´å¤šæ•°æ®æç¤º -->
            <view class="no-more-data" wx:if="{{!hasMoreHistory && statusHistoryList.length > 0 && historyPage > 1}}">
              <text>æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
            </view>
          </view>
        </scroll-view>
        
        <view class="no-history" wx:elif="{{showStatusHistory && !loadingHistory}}">
          <text class="no-history-text">æš‚æ— çŠ¶æ€å˜æ›´è®°å½•</text>
        </view>
      </view>
    </view>
    
    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="order-info">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      
      <view class="info-item">
        <text class="label">è®¢å•ç¼–å·</text>
        <text class="value">{{orderInfo._id}}</text>
      </view>
      <view class="info-item">
        <text class="label">ä¸‹å•æ—¶é—´</text>
        <text class="value">{{orderInfo.createTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.payTime}}">
        <text class="label">æ”¯ä»˜æ—¶é—´</text>
        <text class="value">{{orderInfo.payTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.acceptTime}}">
        <text class="label">æ¥å•æ—¶é—´</text>
        <text class="value">{{orderInfo.acceptTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.deliverTime}}">
        <text class="label">é…é€æ—¶é—´</text>
        <text class="value">{{orderInfo.deliverTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.deliveredTime}}">
        <text class="label">é…é€å®Œæˆæ—¶é—´</text>
        <text class="value">{{orderInfo.deliveredTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.refundingTime}}">
        <text class="label">é€€æ¬¾æ—¶é—´</text>
        <text class="value">{{orderInfo.refundingTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.completeTime}}">
        <text class="label">å®Œæˆæ—¶é—´</text>
        <text class="value">{{orderInfo.completeTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.status === 'cancelled' && orderInfo.cancelTime}}">
        <text class="label">ä¸­æ­¢æ—¶é—´</text>
        <text class="value">{{orderInfo.cancelTime}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.status === 'cancelled' && orderInfo.cancelReason}}">
        <text class="label">ä¸­æ­¢åŸå› </text>
        <text class="value cancel-reason">{{orderInfo.cancelReason}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.status === 'cancelled' && orderInfo.cancelOperator}}">
        <text class="label">æ“ä½œäºº</text>
        <text class="value cancel-operator">{{orderInfo.cancelOperator}}</text>
      </view>
      <view class="info-item">
        <text class="label">æ”¯ä»˜çŠ¶æ€</text>
        <text class="value payment-refunded" wx:if="{{orderInfo.status === 'cancelled'}}">å·²é€€æ¬¾</text>
        <text class="value payment-refunding" wx:elif="{{orderInfo.status === 'refunding'}}">é€€æ¬¾ä¸­</text>
        <text class="value" wx:else>{{orderInfo.isPaid ? 'å·²æ”¯ä»˜' : 'æœªæ”¯ä»˜'}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.remark}}">
        <text class="label">è®¢å•å¤‡æ³¨</text>
        <text class="value">{{orderInfo.remark}}</text>
      </view>
    </view>
    
    <!-- é…é€ä¿¡æ¯ -->
    <view class="delivery-section">
      <view class="section-title">é…é€ä¿¡æ¯</view>
      
      <view class="address-content">
        <view class="address-line">
          <text class="label">æ”¶è´§äººï¼š</text>
          <text class="value">{{orderInfo.contactName || 'æœªæä¾›'}}</text>
        </view>
        <view class="address-line">
          <text class="label">è”ç³»ç”µè¯ï¼š</text>
          <text class="value">{{orderInfo.contactPhone || 'æœªæä¾›'}}</text>
        </view>
        <view class="address-line">
          <text class="label">æ”¶è´§åœ°å€ï¼š</text>
          <text class="value">{{orderInfo.address || 'æœªæä¾›'}}</text>
        </view>
      </view>
    </view>
    
    <!-- è®¢å•é‡‘é¢ -->
    <view class="order-price">
      <view class="section-title">è®¢å•é‡‘é¢</view>
      
      <view class="price-item">
        <text class="label">å•†å“æ€»é¢</text>
        <text class="value">Â¥{{orderInfo.formattedTotalPrice || '0.00'}}</text>
      </view>
      <view class="price-item">
        <text class="label">é…é€è´¹</text>
        <text class="value">Â¥0.00</text>
      </view>
      <view class="price-item total">
        <text class="label">å®ä»˜æ¬¾</text>
        <text class="value">Â¥{{orderInfo.formattedTotalPrice || '0.00'}}</text>
      </view>
    </view>

    <!-- ğŸ†• è®¢å•æ“ä½œæŒ‰é’®åŒºåŸŸï¼ˆå¢å¼ºç‰ˆï¼‰ -->
    <view class="action-buttons" wx:if="{{!loading && orderInfo}}">
      <!-- å·²æ”¯ä»˜çŠ¶æ€çš„æ¥å•æŒ‰é’® -->
      <block wx:if="{{orderInfo.status === 'paid'}}">
        <button class="action-btn primary" bindtap="acceptOrder">
          æ¥å•
        </button>
        
        <button class="action-btn danger" bindtap="cancelOrderByAdmin">
          ä¸­æ­¢è®¢å•
        </button>
      </block>
      
      <!-- å·²æ¥å•çŠ¶æ€çš„é…é€æŒ‰é’® -->
      <block wx:if="{{orderInfo.status === 'accepted'}}">
        <button class="action-btn primary" bindtap="startDelivery">
          å¼€å§‹é…é€
        </button>
        
        <button class="action-btn danger" bindtap="cancelOrderByAdmin">
          ä¸­æ­¢è®¢å•
        </button>
      </block>
      
      <!-- é…é€ä¸­çŠ¶æ€çš„é…é€å®ŒæˆæŒ‰é’® -->
      <block wx:if="{{orderInfo.status === 'delivering'}}">
        <button class="action-btn primary" bindtap="completeDelivery">
          é…é€å®Œæˆ
        </button>
        
        <button class="action-btn danger" bindtap="cancelOrderByAdmin">
          ä¸­æ­¢è®¢å•
        </button>
      </block>
      
      <!-- ğŸ†• é€€æ¬¾çŠ¶æ€ä¸“ç”¨æŒ‰é’® -->
      <block wx:if="{{orderInfo.status === 'refunding'}}">
        <button class="action-btn warning pulse" bindtap="checkRefundProgress">
          <text class="progress-icon">â³</text>
          æŸ¥çœ‹é€€æ¬¾è¿›åº¦
        </button>
      </block>
    </view>

    <!-- é€€æ¬¾ä¸­çŠ¶æ€çš„è¯´æ˜ -->
    <view class="status-info" wx:if="{{orderInfo.status === 'refunding'}}">
      <view class="refunding-info">
        <text class="info-title">ğŸ”„ è®¢å•é€€æ¬¾å¤„ç†ä¸­</text>
        <text class="info-desc">ç³»ç»Ÿæ­£åœ¨å¤„ç†é€€æ¬¾ï¼Œè¯·ç­‰å¾…å¾®ä¿¡æ”¯ä»˜ç¡®è®¤</text>
        <text class="info-note">é€€æ¬¾å®Œæˆåè®¢å•çŠ¶æ€å°†è‡ªåŠ¨æ›´æ–°ä¸ºå·²ä¸­æ­¢</text>
      </view>
    </view>

    <!-- å…¶ä»–çŠ¶æ€çš„è¯´æ˜ä¿¡æ¯ -->
    <view class="status-info" wx:if="{{!loading && orderInfo && orderInfo.status !== 'paid' && orderInfo.status !== 'refunding' && orderInfo.status !== 'accepted' && orderInfo.status !== 'delivering'}}">
      <text class="info-text">å½“å‰çŠ¶æ€ä¸‹æ— å¯æ‰§è¡Œæ“ä½œ</text>
    </view>
  </block>
  
  <view class="empty-data" wx:else>
    <text>è®¢å•ä¸å­˜åœ¨æˆ–å·²åˆ é™¤</text>
  </view>
  
  <!-- é€€æ¬¾è¯¦æƒ…å¼¹çª— -->
  <view class="refund-details-modal" wx:if="{{showRefundDetails}}">
    <view class="modal-mask" bindtap="closeRefundDetails"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é€€æ¬¾è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeRefundDetails">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="refund-detail-item">
          <text class="label">é€€æ¬¾å•å·</text>
          <text class="value">{{refundDetails.refundId}}</text>
        </view>
        <view class="refund-detail-item">
          <text class="label">é€€æ¬¾é‡‘é¢</text>
          <text class="value">Â¥{{refundDetails.refundFee/100}}</text>
        </view>
        <view class="refund-detail-item">
          <text class="label">é€€æ¬¾åŸå› </text>
          <text class="value">{{refundDetails.refundReason}}</text>
        </view>
        <view class="refund-detail-item">
          <text class="label">é€€æ¬¾çŠ¶æ€</text>
          <text class="value">{{refundDetails.statusText}}</text>
        </view>
        <view class="refund-detail-item">
          <text class="label">ç”³è¯·æ—¶é—´</text>
          <text class="value">{{refundDetails.createTime}}</text>
        </view>
      </view>
      
      <view class="modal-footer" wx:if="{{refundDetails.status === 'PROCESSING'}}">
        <view class="btn btn-reject" bindtap="rejectRefund">æ‹’ç»é€€æ¬¾</view>
        <view class="btn btn-approve" bindtap="approveRefund">é€šè¿‡é€€æ¬¾</view>
      </view>
    </view>
  </view>
</view> 